{% extends 'base.html' %}
{% load static %}
{% load core_extras %}
{% load l10n %}

{% block title %}{{ seo_title|default:'Catalogo - FLEXS' }}{% endblock %}
{% block meta_description %}{{ seo_description|default:'Catalogo de productos FLEXS.' }}{% endblock %}
{% block extra_head %}
<link rel="canonical" href="{{ canonical_url }}">
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'core/css/catalog.css' %}">
{% endblock %}

{% block content %}
<div class="catalog-page">
    {% csrf_token %}
    <div class="container">
        <div class="catalog-header">
            <div class="catalog-header-main">
                <h1>Catalogo de Productos</h1>
                <p class="catalog-subtitle">
                    {% if current_category and current_category_has_descendants %}
                    <span class="price-notice">
                        Incluye productos de subcategorias de "{{ current_category.name }}"
                    </span><br>
                    {% endif %}
                    {% if not show_prices %}
                    <span class="price-notice">{{ price_message }}</span>
                    {% elif discount %}
                    <span class="discount-notice">
                        Tenes un {{ discount|multiply:100|floatformat:0 }}% de descuento aplicado
                    </span>
                    {% endif %}
                </p>
            </div>
            <div class="catalog-header-stats">
                <span class="header-stat">
                    <strong>{{ page_obj.paginator.count }}</strong>
                    productos
                </span>
                {% if current_category %}
                <span class="header-stat">
                    categoria: <strong>{{ current_category.name }}</strong>
                </span>
                {% endif %}
                {% if search_query %}
                <span class="header-stat">
                    busqueda: <strong>{{ search_query }}</strong>
                </span>
                {% endif %}
            </div>
        </div>

        <button
            type="button"
            class="catalog-mobile-filter-btn"
            id="catalogMobileFilterBtn"
            onclick="openCatalogFilters()"
        >
            Filtrar catalogo
        </button>
        <div class="catalog-overlay" id="catalogOverlay" onclick="closeCatalogFilters()"></div>

        <div class="catalog-layout">
            <aside class="catalog-sidebar" id="catalogSidebar">
                <div class="catalog-sidebar-head">
                    <h3>Filtros</h3>
                    <button type="button" class="catalog-sidebar-close" onclick="closeCatalogFilters()">
                        Cerrar
                    </button>
                </div>

                <div class="filter-section">
                    <h3>Buscar</h3>
                    <form method="get" class="search-form">
                        <input type="hidden" name="category" value="{{ category_slug }}">
                        <input type="hidden" name="order" value="{{ order_by }}">
                        <input
                            type="text"
                            name="q"
                            value="{{ search_query }}"
                            placeholder="SKU o nombre..."
                            class="form-input"
                        >
                        <button type="submit" class="btn btn-primary">Buscar</button>
                    </form>
                </div>

                <div class="filter-section">
                    <h3>Abrazaderas a medida</h3>
                    <p class="text-muted" style="margin:0 0 8px;">
                        Si no encontras la medida, calcula y envia una solicitud personalizada.
                    </p>
                    {% if can_use_clamp_measure %}
                    <a href="{% url 'catalog_clamp_request' %}" class="btn btn-outline" style="width:100%;">
                        Cotizar medida especial
                    </a>
                    {% elif user.is_authenticated %}
                    <p class="text-muted" style="margin:0;">
                        Disponible solo para clientes aprobados y administradores.
                    </p>
                    {% else %}
                    <a href="{% url 'login' %}?next={% url 'catalog_clamp_request' %}" class="btn btn-outline" style="width:100%;">
                        Iniciar sesion para cotizar
                    </a>
                    {% endif %}
                </div>

                <div class="filter-section">
                    <div class="category-filter-header">
                        <h3>Categorias</h3>
                        <div class="category-filter-header-actions">
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="expandAllCategoryTree()">
                                Expandir
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="collapseAllCategoryTree()">
                                Ocultar
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="toggleCategoriesBtn">
                                Ver
                            </button>
                        </div>
                    </div>
                    <div id="categoriesWrapper" style="display: none;">
                        <div class="category-tree">
                            <a href="{% url 'catalog' %}" class="category-tree-link category-tree-link-root {% if not category_slug %}active{% endif %}">
                                <span class="category-tree-label">Todas</span>
                            </a>

                            {% for row in category_tree_rows %}
                            <div
                                class="category-tree-row {% if row.has_children %}has-children{% endif %}{% if row.category.id in expanded_category_ids %} expanded{% endif %}"
                                data-category-id="{{ row.category.id }}"
                                data-parent-id="{{ row.category.parent_id|default:'' }}"
                                data-depth="{{ row.depth }}"
                                style="--depth: {{ row.depth }};"
                            >
                                <div class="category-tree-main">
                                    {% if row.has_children %}
                                    <button
                                        type="button"
                                        class="category-tree-toggle"
                                        onclick="toggleCategoryTree(event, '{{ row.category.id }}')"
                                        aria-label="Mostrar subcategorias de {{ row.category.name }}"
                                    >
                                        <span class="category-toggle-icon">&#9654;</span>
                                    </button>
                                    {% else %}
                                    <span class="category-tree-spacer"></span>
                                    {% endif %}

                                    <a
                                        href="?category={{ row.category.slug }}"
                                        class="category-tree-link {% if category_slug == row.category.slug %}active{% endif %}"
                                        title="{{ row.full_path }}"
                                    >
                                        <span class="category-tree-label">{{ row.category.name }}</span>
                                        {% if row.has_children %}
                                        <span class="category-tree-count">{{ row.children_count }}</span>
                                        {% endif %}
                                    </a>
                                </div>

                                {% if row.category.slug == category_slug and clamp_options or row.category.slug == category_slug and category_attributes %}
                                <div class="category-inline-filters" style="--depth: {{ row.depth }};">
                                    <form method="get" action="{% url 'catalog' %}" class="inline-filter-form">
                                        <input type="hidden" name="q" value="{{ search_query }}">
                                        <input type="hidden" name="category" value="{{ category_slug }}">
                                        <input type="hidden" name="order" value="{{ order_by }}">

                                        {% if clamp_options %}
                                        <div class="category-inline-title">Filtros tecnicos</div>
                                        {% for field, options in clamp_options.items %}
                                        <div class="filter-mini-group">
                                            <label>{{ field_labels|get_item:field|default:field|title }}</label>
                                            <select name="{{ field }}" class="form-select-mini" onchange="this.form.submit()">
                                                <option value="">- Todos -</option>
                                                {% for opt in options %}
                                                {% with field_val=active_filters|get_item:field %}
                                                {% with opt_str=opt|stringformat:"s" %}
                                                <option value="{{ opt }}" {% if field_val == opt_str %}selected{% endif %}>{{ opt }}</option>
                                                {% endwith %}
                                                {% endwith %}
                                                {% endfor %}
                                            </select>
                                        </div>
                                        {% endfor %}
                                        {% endif %}

                                        {% if category_attributes %}
                                        <div class="category-inline-title">Atributos</div>
                                        {% for attr in category_attributes %}
                                        <div class="filter-mini-group">
                                            <label>{{ attr.name }}</label>
                                            {% if attr.type == 'select' %}
                                            <select name="{{ attr.slug }}" class="form-select-mini" onchange="this.form.submit()">
                                                <option value="">- Todos -</option>
                                                {% for opt in attr.options_list %}
                                                {% with current_val=active_filters|get_item:attr.slug %}
                                                <option value="{{ opt }}" {% if current_val == opt %}selected{% endif %}>{{ opt }}</option>
                                                {% endwith %}
                                                {% endfor %}
                                            </select>
                                            {% else %}
                                            <input
                                                type="text"
                                                name="{{ attr.slug }}"
                                                value="{{ active_filters|get_item:attr.slug|default:'' }}"
                                                class="form-input form-input-sm"
                                                placeholder="Filtrar..."
                                            >
                                            {% endif %}
                                        </div>
                                        {% endfor %}
                                        {% endif %}

                                        <div class="category-inline-actions">
                                            <button type="submit" class="btn btn-primary btn-sm">Aplicar</button>
                                            {% if active_filters %}
                                            <a href="?category={{ category_slug }}&q={{ search_query }}&order={{ order_by }}" class="btn btn-outline btn-sm">
                                                Limpiar
                                            </a>
                                            {% endif %}
                                        </div>
                                    </form>
                                </div>
                                {% endif %}
                            </div>
                            {% empty %}
                            <p class="text-muted">No hay categorias activas.</p>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </aside>

            <main class="catalog-main">
                <div class="catalog-toolbar">
                    <div class="toolbar-meta">
                        <span class="result-count">
                            {{ page_obj.paginator.count }} productos encontrados
                        </span>
                    </div>
                    <div class="toolbar-actions">
                        <select name="order" class="form-select order-select" onchange="updateOrder(this.value)">
                            <option value="name" {% if order_by == 'name' %}selected{% endif %}>Nombre A-Z</option>
                            <option value="-name" {% if order_by == '-name' %}selected{% endif %}>Nombre Z-A</option>
                            <option value="price" {% if order_by == 'price' %}selected{% endif %}>Menor precio</option>
                            <option value="-price" {% if order_by == '-price' %}selected{% endif %}>Mayor precio</option>
                            <option value="sku" {% if order_by == 'sku' %}selected{% endif %}>SKU</option>
                        </select>
                    </div>
                </div>

                {% if breadcrumb_categories %}
                <nav class="catalog-breadcrumb">
                    <a href="{% url 'catalog' %}">Catalogo</a>
                    {% for crumb in breadcrumb_categories %}
                    <span>/</span>
                    {% if forloop.last %}
                    <strong>{{ crumb.name }}</strong>
                    {% else %}
                    <a href="{{ crumb.url }}">{{ crumb.name }}</a>
                    {% endif %}
                    {% endfor %}
                </nav>
                {% endif %}

                {% if active_filter_chips %}
                <div class="active-filter-chips">
                    {% for chip in active_filter_chips %}
                    <a class="filter-chip" href="{{ chip.remove_url }}" title="Quitar {{ chip.label }}">
                        <span>{{ chip.label }}: {{ chip.value }}</span>
                        <span class="chip-remove">x</span>
                    </a>
                    {% endfor %}
                </div>
                {% endif %}

                {% if page_obj.object_list %}
                <div class="products-grid">
                    {% for product in page_obj %}
                    <article class="product-card" data-product-id="{{ product.id|unlocalize }}">
                        <a class="product-image" href="{% url 'product_detail' product.sku %}">
                            {% if product.image %}
                            <img src="{{ product.image.url }}" alt="{{ product.name }}">
                            {% else %}
                            <div class="product-placeholder">
                                <span>+</span>
                            </div>
                            {% endif %}
                        </a>
                        <div class="product-info">
                            <div class="product-head">
                                <span class="product-sku">{{ product.sku }}</span>
                                {% if product.stock > 0 %}
                                <span class="product-stock in-stock">En stock</span>
                                {% else %}
                                <span class="product-stock out-stock">Sin stock</span>
                                {% endif %}
                            </div>

                            <h3 class="product-name">
                                <a href="{% url 'product_detail' product.sku %}">{{ product.name }}</a>
                            </h3>

                            {% if product.display_categories %}
                            <div class="product-category-list">
                                {% for cat in product.display_categories %}
                                <span class="product-category">{{ cat.name }}</span>
                                {% endfor %}
                            </div>
                            {% endif %}

                            {% if show_prices %}
                            <div class="product-pricing-details">
                                {% if discount %}
                                <div class="price-row list-price">
                                    <span class="label">Precio lista</span>
                                    <span class="value">${{ product.price|floatformat:2 }}</span>
                                </div>
                                <div class="price-row discount-row">
                                    <span class="label">Descuento</span>
                                    <span class="value">{{ discount|multiply:100|floatformat:0 }}% OFF</span>
                                </div>
                                <div class="price-row final-price">
                                    <span class="label">Precio final</span>
                                    <span class="value">${{ product.final_price|floatformat:2 }}</span>
                                </div>
                                {% else %}
                                <div class="price-row final-price single-price">
                                    <span class="value">${{ product.price|floatformat:2 }}</span>
                                </div>
                                {% endif %}
                            </div>
                            {% else %}
                            <div class="product-pricing">
                                <span class="price-hidden">
                                    <a href="{% url 'login' %}">Iniciar sesion</a> para ver precio
                                </span>
                            </div>
                            {% endif %}

                            <div class="product-actions">
                                <a href="{% url 'product_detail' product.sku %}" class="btn btn-outline product-detail-btn">
                                    Ver detalle
                                </a>
                                {% if user.is_authenticated %}
                                <button
                                    class="btn btn-outline"
                                    onclick="toggleFavorite({{ product.id|unlocalize }}, this)"
                                    data-favorite="{% if product.is_favorite %}1{% else %}0{% endif %}"
                                >
                                    {% if product.is_favorite %}Favorito{% else %}Guardar{% endif %}
                                </button>
                                <button
                                    class="btn btn-primary btn-add-cart"
                                    onclick="addToCart({{ product.id|unlocalize }})"
                                    {% if product.stock <= 0 %}disabled{% endif %}
                                >
                                    Agregar
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </article>
                    {% endfor %}
                </div>

                {% if page_obj.paginator.num_pages > 1 %}
                <nav class="pagination">
                    {% if page_obj.has_previous %}
                    <a href="?{% querystring request page=page_obj.previous_page_number %}" class="page-link">
                        Anterior
                    </a>
                    {% endif %}

                    <span class="page-info">
                        Pagina {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
                    </span>

                    {% if page_obj.has_next %}
                    <a href="?{% querystring request page=page_obj.next_page_number %}" class="page-link">
                        Siguiente
                    </a>
                    {% endif %}
                </nav>
                {% endif %}
                {% else %}
                <div class="no-products">
                    <p>No se encontraron productos con los filtros seleccionados.</p>
                    <a href="{% url 'catalog' %}" class="btn btn-outline">Ver todos los productos</a>
                </div>
                {% endif %}
            </main>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function updateOrder(orderValue) {
        const params = new URLSearchParams(window.location.search);
        params.set('order', orderValue);
        params.delete('page');
        window.location.search = params.toString();
    }

    async function addToCart(productId) {
        try {
            const response = await fetch('/pedidos/carrito/agregar/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({ product_id: productId, quantity: 1 })
            });
            const data = await response.json();
            if (data.success) {
                const badge = document.getElementById('cartBadge');
                if (badge) badge.textContent = data.cart_count;
            } else {
                alert('Error: ' + data.error);
            }
        } catch (error) {
            console.error(error);
            alert('Error al agregar al carrito');
        }
    }

    async function toggleFavorite(productId, btn) {
        try {
            const response = await fetch('/pedidos/favoritos/toggle/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({ product_id: productId })
            });
            const data = await response.json();
            if (!data.success) {
                return;
            }
            const isFavorite = !!data.is_favorite;
            btn.dataset.favorite = isFavorite ? '1' : '0';
            btn.textContent = isFavorite ? 'Favorito' : 'Guardar';
        } catch (error) {
            console.error(error);
        }
    }

    function getDirectTreeChildren(categoryId) {
        return document.querySelectorAll(`.category-tree-row[data-parent-id="${categoryId}"]`);
    }

    function hideTreeDescendants(categoryId) {
        const children = getDirectTreeChildren(categoryId);
        children.forEach((row) => {
            row.style.display = 'none';
            row.classList.remove('expanded');
            hideTreeDescendants(row.dataset.categoryId);
        });
    }

    function setTreeExpanded(categoryId, expanded) {
        const row = document.querySelector(`.category-tree-row[data-category-id="${categoryId}"]`);
        if (!row || !row.classList.contains('has-children')) return;

        if (expanded) {
            getDirectTreeChildren(categoryId).forEach((childRow) => {
                childRow.style.display = 'block';
            });
            row.classList.add('expanded');
        } else {
            row.classList.remove('expanded');
            hideTreeDescendants(categoryId);
        }
    }

    function toggleCategoryTree(event, categoryId) {
        event.preventDefault();
        event.stopPropagation();
        const row = document.querySelector(`.category-tree-row[data-category-id="${categoryId}"]`);
        if (!row) return;
        const expanded = row.classList.contains('expanded');
        setTreeExpanded(categoryId, !expanded);
    }

    function initializeCategoryTree() {
        const rows = document.querySelectorAll('.category-tree-row');
        rows.forEach((row) => {
            row.style.display = row.dataset.depth === '0' ? 'block' : 'none';
        });

        const expandedRows = Array.from(document.querySelectorAll('.category-tree-row.expanded'))
            .sort((a, b) => Number(a.dataset.depth) - Number(b.dataset.depth));
        expandedRows.forEach((row) => {
            setTreeExpanded(row.dataset.categoryId, true);
        });
    }

    function expandAllCategoryTree() {
        document.querySelectorAll('.category-tree-row').forEach((row) => {
            row.style.display = 'block';
            if (row.classList.contains('has-children')) {
                row.classList.add('expanded');
            }
        });
    }

    function collapseAllCategoryTree() {
        document.querySelectorAll('.category-tree-row').forEach((row) => {
            if (row.dataset.depth !== '0') row.style.display = 'none';
            row.classList.remove('expanded');
        });
    }

    function openCatalogFilters() {
        const sidebar = document.getElementById('catalogSidebar');
        const overlay = document.getElementById('catalogOverlay');
        if (!sidebar || !overlay) return;
        sidebar.classList.add('is-open');
        overlay.classList.add('is-open');
        document.body.classList.add('catalog-lock');
    }

    function closeCatalogFilters() {
        const sidebar = document.getElementById('catalogSidebar');
        const overlay = document.getElementById('catalogOverlay');
        if (!sidebar || !overlay) return;
        sidebar.classList.remove('is-open');
        overlay.classList.remove('is-open');
        document.body.classList.remove('catalog-lock');
    }

    function setupCategoryVisibilityToggle() {
        const toggleBtn = document.getElementById('toggleCategoriesBtn');
        const categoriesWrapper = document.getElementById('categoriesWrapper');
        if (!toggleBtn || !categoriesWrapper) return;

        const savedState = localStorage.getItem('catalogCategoriesVisible');
        const shouldShow = savedState === null ? true : savedState === 'true';

        categoriesWrapper.style.display = shouldShow ? 'block' : 'none';
        toggleBtn.textContent = shouldShow ? 'Ocultar' : 'Ver';

        toggleBtn.addEventListener('click', function () {
            const isHidden = categoriesWrapper.style.display === 'none';
            categoriesWrapper.style.display = isHidden ? 'block' : 'none';
            toggleBtn.textContent = isHidden ? 'Ocultar' : 'Ver';
            localStorage.setItem('catalogCategoriesVisible', isHidden ? 'true' : 'false');
        });
    }

    document.addEventListener('DOMContentLoaded', function () {
        initializeCategoryTree();
        setupCategoryVisibilityToggle();
    });
</script>
{% endblock %}
