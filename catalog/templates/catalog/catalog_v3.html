{# FIXED VERSION - WITH AUTO-SUBMIT UX #}
{% extends 'base.html' %}
{% load static %}
{% load core_extras %}

{% block title %}Cat√°logo - FLEXS{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'core/css/catalog.css' %}?v={% now 'U' %}">
{% endblock %}

{% block content %}
<div class="catalog-page">
    {% csrf_token %}
    <div class="container">
        <div class="catalog-header">
            <h1>Cat√°logo de Productos</h1>
            <p class="catalog-subtitle">
                {% if not show_prices %}
                <span class="price-notice">{{ price_message }}</span>
                {% elif discount %}
                <span class="discount-notice">Ten√©s un {{ discount|multiply:100|floatformat:0 }}% de descuento
                    aplicado</span>
                {% endif %}
            </p>
        </div>

        <div class="catalog-layout">
            <!-- Sidebar Filters -->
            <aside class="catalog-sidebar">
                <div class="filter-section">
                    <h3>Buscar</h3>
                    <form method="get" class="search-form">
                        <input type="text" name="q" value="{{ search_query }}" placeholder="SKU o nombre..."
                            class="form-input">
                        <button type="submit" class="btn btn-primary">Buscar</button>
                    </form>
                </div>

                <div class="filter-section">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h3 style="margin-bottom: 0;">Categor√≠as</h3>
                        <button type="button" class="btn btn-sm btn-outline-secondary" id="toggleCategoriesBtn"
                            style="padding: 2px 8px; font-size: 0.8rem;">
                            Ver
                        </button>
                    </div>
                    <div id="categoriesWrapper" style="display: none;">
                        <ul class="category-list">
                            <li>
                                <a href="{% url 'catalog' %}"
                                    class="category-link-wrapper {% if not category_slug %}active{% endif %}">
                                    <span>Todas</span>
                                </a>
                            </li>
                            {% for category in categories %}
                            <li>
                                <div class="category-item">
                                    <a href="?category={{ category.slug }}"
                                        class="category-link-wrapper {% if category_slug == category.slug %}active{% endif %} {% if category.id in expanded_category_ids %}expanded{% endif %}"
                                        data-category-slug="{{ category.slug }}"
                                        onclick="toggleCategory(event, this, 'cat-{{ category.id }}')">

                                        <span>{{ category.name }}</span>

                                        {% if category.children.exists %}
                                        <span
                                            class="category-toggle-icon {% if category.id in expanded_category_ids %}rotated{% endif %}">
                                            ‚ñº
                                        </span>
                                        {% endif %}
                                    </a>
                                </div>

                                {# Inline filters for Abrazaderas (Keep existing logic) #}
                                {% if 'ABRAZADERA' in category.name.upper and category_slug == category.slug and clamp_options %}
                                <div class="category-filters-collapse"
                                    style="display: block; margin-left: 10px; margin-bottom: 10px;">
                                    <form method="get" action="{% url 'catalog' %}" class="inline-filter-form">
                                        <input type="hidden" name="q" value="{{ search_query }}">
                                        <input type="hidden" name="category" value="{{ category_slug }}">
                                        <input type="hidden" name="order" value="{{ order_by }}">

                                        {% for field, options in clamp_options.items %}
                                        <div class="filter-mini-group">
                                            <label>{{ field|title }}</label>
                                            <select name="{{ field }}" class="form-select-mini"
                                                onchange="this.form.submit()">
                                                <option value="">- Todos -</option>
                                                {% for opt in options %}
                                                {% with field_val=active_filters|get_item:field %}
                                                {% with opt_str=opt|stringformat:"s" %}
                                                <option value="{{ opt }}" {% if field_val == opt_str %}selected{% endif %}>{{ opt }}</option>
                                                {% endwith %}
                                                {% endwith %}
                                                {% endfor %}
                                            </select>
                                        </div>
                                        {% endfor %}
                                    </form>
                                </div>
                                {% endif %}

                                {% if category.children.exists %}
                                <ul class="subcategory-list {% if category.id in expanded_category_ids %}visible{% endif %}"
                                    id="cat-{{ category.id }}">
                                    {% for sub in category.children.all %}
                                    <li>
                                        <a href="?category={{ sub.slug }}"
                                            class="{% if category_slug == sub.slug %}active{% endif %}">
                                            {{ sub.name }}
                                        </a>
                                    </li>
                                    {% endfor %}
                                </ul>
                                {% endif %}
                            </li>
                            {% endfor %}
                        </ul>

                        <script>
                            function toggleCategory(event, element, targetId) {
                                // Logic:
                                // 1. If click is on the ICON (arrow), prevent navigation and just toggle visibility.
                                // 2. If click is on the TEXT:
                                //    a. If category is ACTIVE (current), prevent reload and toggle visibility.
                                //    b. If category is INACTIVE, let it navigate (backend will handle expansion).

                                const target = document.getElementById(targetId);
                                if (!target) return; // No children to toggle

                                // Check if the click target is the icon or inside it
                                const isIconClick = event.target.classList.contains('category-toggle-icon') ||
                                    event.target.closest('.category-toggle-icon');

                                // Check if this is the currently active category
                                const isActive = element.classList.contains('active');

                                if (isIconClick || isActive) {
                                    event.preventDefault(); // Stop navigation
                                    event.stopPropagation(); // Stop bubbling (good practice)

                                    // Toggle visual state
                                    const list = document.getElementById(targetId);
                                    if (list) list.classList.toggle('visible');

                                    element.classList.toggle('expanded');

                                    const icon = element.querySelector('.category-toggle-icon');
                                    if (icon) icon.classList.toggle('rotated');

                                    return; // Done
                                }

                                // If clicking the text of an INACTIVE category, we allow navigation.
                                // Optional: If we want to force expand visually right before reload for better UX:
                                if (!element.classList.contains('expanded')) {
                                    element.classList.add('expanded');
                                    const icon = element.querySelector('.category-toggle-icon');
                                    if (icon) icon.classList.add('rotated');
                                }
                            }
                        </script>
                    </div>
                </div>

                {% if category_attributes %}
                <div class="filter-section">
                    <h3>Otros Filtros</h3>
                    <form method="get" action="{% url 'catalog' %}">
                        <!-- Preserve other parameters -->
                        <input type="hidden" name="q" value="{{ search_query }}">
                        <input type="hidden" name="category" value="{{ category_slug }}">
                        <input type="hidden" name="order" value="{{ order_by }}">
                        <!-- Preserve technical filters if they exist -->
                        <input type="hidden" name="fabrication" value="{{ active_filters.fabrication|default:'' }}">
                        <input type="hidden" name="diameter" value="{{ active_filters.diameter|default:'' }}">
                        <input type="hidden" name="width" value="{{ active_filters.width|default:'' }}">
                        <input type="hidden" name="length" value="{{ active_filters.length|default:'' }}">
                        <input type="hidden" name="shape" value="{{ active_filters.shape|default:'' }}">

                        {% for attr in category_attributes %}
                        <div class="filter-group mb-3">
                            <h4 class="filter-title"
                                style="font-size: 0.95em; margin-bottom: 5px; color: var(--color-gray);">
                                {{ attr.name }}
                            </h4>

                            {% if attr.type == 'select' %}
                            <select name="{{ attr.slug }}" class="form-select form-select-sm" style="width: 100%;"
                                onchange="this.form.submit()">
                                <option value="">- Todos -</option>
                                {% for opt in attr.options_list %}
                                {% with current_val=active_filters|get_item:attr.slug %}
                                <option value="{{ opt }}" {% if current_val == opt %}selected {% endif %}>
                                    {{ opt }}
                                </option>
                                {% endwith %}
                                {% endfor %}
                            </select>
                            {% else %}
                            <input type="text" name="{{ attr.slug }}"
                                value="{{ active_filters|get_item:attr.slug|default:'' }}"
                                class="form-input form-input-sm" placeholder="Filtrar..." style="width: 100%;">
                            {% endif %}
                        </div>
                        {% endfor %}

                        <noscript>
                            <button type="submit" class="btn btn-primary btn-sm btn-block mt-3" style="width: 100%;">
                                Aplicar Filtros
                            </button>
                        </noscript>

                        {% if active_filters %}
                        <a href="?category={{ category_slug }}&q={{ search_query }}"
                            class="btn btn-outline btn-sm btn-block mt-2"
                            style="width: 100%; text-align: center; display: block;">
                            Limpiar Filtros
                        </a>
                        {% endif %}
                    </form>
                </div>
                {% endif %}
            </aside>

            <!-- Products Grid -->
            <main class="catalog-main">
                <div class="catalog-toolbar">
                    <span class="result-count">
                        {{ page_obj.paginator.count }} productos encontrados
                    </span>
                    <select name="order" class="form-select order-select"
                        onchange="window.location.href='?order='+this.value+'&q={{ search_query }}&category={{ category_slug }}'">
                        <option value="name" {% if order_by == 'name' %}selected {% endif %}>Nombre A-Z</option>
                        <option value="-name" {% if order_by == '-name' %}selected {% endif %}>Nombre Z-A</option>
                        <option value="price" {% if order_by == 'price' %}selected {% endif %}>Menor precio</option>
                        <option value="-price" {% if order_by == '-price' %}selected {% endif %}>Mayor precio</option>
                        <option value="sku" {% if order_by == 'sku' %}selected {% endif %}>SKU</option>
                    </select>
                </div>

                {% if page_obj.object_list %}
                <div class="products-grid">
                    {% for product in page_obj %}
                    <div class="product-card" data-product-id="{{ product.id }}">
                        <div class="product-image">
                            {% if product.image %}
                            <img src="{{ product.image.url }}" alt="{{ product.name }}">
                            {% else %}
                            <div class="product-placeholder">
                                <span>üì¶</span>
                            </div>
                            {% endif %}
                        </div>
                        <div class="product-info">
                            <span class="product-sku">{{ product.sku }}</span>
                            <h3 class="product-name">{{ product.name }}</h3>
                            {% if product.category %}
                            <span class="product-category">{{ product.category.name }}</span>
                            {% endif %}

                            {% if show_prices %}
                            <div class="product-pricing-details">
                                {% if discount %}
                                <div class="price-row list-price">
                                    <span class="label">Precio Lista:</span>
                                    <span class="value">${{ product.price|floatformat:2 }}</span>
                                </div>
                                <div class="price-row discount-row">
                                    <span class="label">Descuento:</span>
                                    <span class="value">{{ discount|multiply:100|floatformat:0 }}% OFF</span>
                                </div>
                                <div class="price-row final-price">
                                    <span class="label">Precio Final:</span>
                                    <span class="value">${{ product.price|calculate_discount:discount|floatformat:2
                                        }}</span>
                                </div>
                                {% else %}
                                <div class="price-row final-price single-price">
                                    <span class="value">${{ product.price|floatformat:2 }}</span>
                                </div>
                                {% endif %}
                            </div>
                            {% else %}
                            <div class="product-pricing">
                                <span class="price-hidden">
                                    <a href="{% url 'login' %}">Iniciar sesi√≥n</a> para ver precio
                                </span>
                            </div>
                            {% endif %}

                            {% if user.is_authenticated %}
                            <button class="btn btn-primary btn-add-cart" onclick="addToCart({{ product.id }})">
                                Agregar al carrito
                            </button>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- Pagination -->
                {% if page_obj.paginator.num_pages > 1 %}
                <nav class="pagination">
                    {% if page_obj.has_previous %}
                    <a href="?page={{ page_obj.previous_page_number }}&q={{ search_query }}&category={{ category_slug }}&order={{ order_by }}"
                        class="page-link">‚Üê Anterior</a>
                    {% endif %}

                    <span class="page-info">
                        P√°gina {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
                    </span>

                    {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}&q={{ search_query }}&category={{ category_slug }}&order={{ order_by }}"
                        class="page-link">Siguiente ‚Üí</a>
                    {% endif %}
                </nav>
                {% endif %}

                {% else %}
                <div class="no-products">
                    <p>No se encontraron productos con los filtros seleccionados.</p>
                    <a href="{% url 'catalog' %}" class="btn btn-outline">Ver todos los productos</a>
                </div>
                {% endif %}
            </main>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Shopping Cart Logic
    async function addToCart(productId) {
        try {
            const response = await fetch('/pedidos/carrito/agregar/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({ product_id: productId, quantity: 1 })
            });
            const data = await response.json();
            if (data.success) {
                // Update cart badge
                const badge = document.getElementById('cartBadge');
                if (badge) badge.textContent = data.cart_count;
                // Optional: Show success message
                // alert(data.message);
            } else {
                alert('Error: ' + data.error);
            }
        } catch (error) {
            console.error(error);
            alert('Error al agregar al carrito');
        }
    }

    // Category Visibility Toggle
    const toggleBtn = document.getElementById('toggleCategoriesBtn');
    const categoriesWrapper = document.getElementById('categoriesWrapper');

    if (toggleBtn && categoriesWrapper) {
        // One-time reset: Force categories hidden for all users
        if (!localStorage.getItem('categoriesResetV1')) {
            localStorage.setItem('categoriesVisible', 'false');
            localStorage.setItem('categoriesResetV1', 'true');
        }

        // Load saved state from localStorage (default: hidden)
        const savedState = localStorage.getItem('categoriesVisible');
        const shouldShow = savedState === 'true';

        // Apply saved state
        if (shouldShow) {
            categoriesWrapper.style.display = 'block';
            toggleBtn.textContent = 'Ocultar';
        } else {
            categoriesWrapper.style.display = 'none';
            toggleBtn.textContent = 'Ver';
        }

        // Toggle and save state on click
        toggleBtn.addEventListener('click', function () {
            const isHidden = categoriesWrapper.style.display === 'none';
            if (isHidden) {
                categoriesWrapper.style.display = 'block';
                toggleBtn.textContent = 'Ocultar';
                localStorage.setItem('categoriesVisible', 'true');
            } else {
                categoriesWrapper.style.display = 'none';
                toggleBtn.textContent = 'Ver';
                localStorage.setItem('categoriesVisible', 'false');
            }
        });
    }

    // Accordion Logic (existing code below)
    document.addEventListener('DOMContentLoaded', function () {
        const toggles = document.querySelectorAll('.category-clickable');

        toggles.forEach(toggle => {
            // Check if this category has filters (it will be the next sibling element)
            const filters = toggle.nextElementSibling;

            if (filters && filters.classList.contains('category-filters-collapse')) {
                // Initialize state
                toggle.setAttribute('aria-expanded', 'true');

                toggle.addEventListener('click', function (e) {
                    e.preventDefault();
                    const isHidden = filters.style.display === 'none';
                    filters.style.display = isHidden ? 'block' : 'none';
                    this.setAttribute('aria-expanded', isHidden ? 'true' : 'false');
                });
            }
        });
    });
</script>
{% endblock %}