{% extends 'base.html' %}
{% load static %}
{% load l10n %}

{% block title %}{{ seo_title|default:product.name }}{% endblock %}
{% block meta_description %}{{ seo_description }}{% endblock %}
{% block extra_head %}
<link rel="canonical" href="{{ canonical_url }}">
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'core/css/catalog.css' %}">
{% endblock %}

{% block content %}
<div class="product-detail-page">
    <div class="container">
        {% if category_breadcrumb %}
        <nav class="catalog-breadcrumb detail-breadcrumb">
            <a href="{% url 'catalog' %}">Catalogo</a>
            {% for crumb in category_breadcrumb %}
            <span>/</span>
            <a href="{{ crumb.url }}">{{ crumb.name }}</a>
            {% endfor %}
            <span>/</span>
            <strong>{{ product.name }}</strong>
        </nav>
        {% endif %}

        <a href="{% url 'catalog' %}" class="btn btn-outline detail-back-btn">Volver al catalogo</a>

        <article class="product-detail-card">
            <div class="product-media">
                {% if product.image %}
                <img src="{{ product.image.url }}" alt="{{ product.name }}">
                {% else %}
                <div class="product-placeholder">Sin imagen</div>
                {% endif %}
            </div>

            <div class="product-data">
                <p class="sku">SKU: {{ product.sku }}</p>
                <h1>{{ product.name }}</h1>

                {% if display_categories %}
                <div class="detail-categories">
                    {% for cat in display_categories %}
                    <span class="detail-category">{{ cat.name }}</span>
                    {% endfor %}
                </div>
                {% endif %}

                {% if show_prices %}
                <div class="price-box">
                    {% if discount %}
                    <p class="detail-list-price">Precio de lista: ${{ product.price|floatformat:2 }}</p>
                    <p class="detail-discount">Descuento: {{ discount_percentage|floatformat:0 }}%</p>
                    <p class="price-final">Precio final: ${{ final_price|floatformat:2 }}</p>
                    {% else %}
                    <p class="price-final">${{ product.price|floatformat:2 }}</p>
                    {% endif %}
                </div>
                {% else %}
                <p class="price-hidden">{{ price_message }}</p>
                {% endif %}

                {% if product.description %}
                <div class="description">
                    <h3>Descripcion</h3>
                    <p>{{ product.description }}</p>
                </div>
                {% endif %}

                {% if user.is_authenticated %}
                <div style="display:flex;gap:10px;flex-wrap:wrap;">
                    <button class="btn btn-primary" onclick="addToCart({{ product.id|unlocalize }})" {% if product.stock <= 0 %}disabled{% endif %}>
                        Agregar al carrito
                    </button>
                    <button
                        class="btn btn-outline"
                        id="favoriteBtn"
                        onclick="toggleFavorite({{ product.id|unlocalize }}, this)"
                        data-favorite="{% if is_favorite %}1{% else %}0{% endif %}"
                    >
                        {% if is_favorite %}Favorito{% else %}Guardar favorito{% endif %}
                    </button>
                </div>
                {% endif %}
            </div>
        </article>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    async function addToCart(productId) {
        try {
            const response = await fetchWithCSRF('/pedidos/carrito/agregar/', {
                method: 'POST',
                body: JSON.stringify({ product_id: productId, quantity: 1 })
            });
            const data = await response.json();
            if (data.success) {
                window.location.href = "{% url 'cart' %}";
            } else {
                alert(data.error || 'No se pudo agregar el producto');
            }
        } catch (error) {
            alert('No se pudo agregar el producto');
        }
    }

    async function toggleFavorite(productId, btn) {
        try {
            const response = await fetchWithCSRF('/pedidos/favoritos/toggle/', {
                method: 'POST',
                body: JSON.stringify({ product_id: productId })
            });
            const data = await response.json();
            if (data.success) {
                const isFavorite = !!data.is_favorite;
                btn.dataset.favorite = isFavorite ? '1' : '0';
                btn.textContent = isFavorite ? 'Favorito' : 'Guardar favorito';
            }
        } catch (error) {
            console.error('Error toggling favorite', error);
        }
    }
</script>
{% endblock %}
