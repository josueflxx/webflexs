{% extends 'admin_panel/base.html' %}

{% block page_title %}Importar Datos{% endblock %}

{% block content %}
<div class="admin-form-container" style="max-width: 600px; margin: 0 auto;">
    <h2 class="mb-3">Importar {{ import_type|title }}</h2>

    <div class="alert alert-info">
        <strong>Instrucciones:</strong>
        <ul class="mt-2" style="margin-left: 1.5rem;">
            <li>El archivo debe ser formato <strong>.xlsx</strong> (Excel).</li>
            <li>La primera fila debe contener los encabezados exactos.</li>
            <li>SKU es obligatorio para productos.</li>
        </ul>
    </div>

    <form id="importForm" method="post" enctype="multipart/form-data">
        {% csrf_token %}

        <div class="form-group">
            <label for="{{ form.file.id_for_label }}" class="form-label">{{ form.file.label }}</label>
            {{ form.file }}
        </div>

        <div class="form-group">
            <div class="flex items-center gap-2">
                {{ form.dry_run }}
                <label for="{{ form.dry_run.id_for_label }}" style="margin-bottom: 0; cursor: pointer;">
                    {{ form.dry_run.label }}
                </label>
            </div>
            <small class="text-muted" style="display: block; margin-top: 5px; margin-left: 1.5rem;">
                {{ form.dry_run.help_text }}
            </small>
        </div>

        {% if form.update_existing %}
        <div class="form-group">
            {{ form.update_existing }} {{ form.update_existing.label }}
        </div>
        {% endif %}

        <div class="form-actions">
            <button type="submit" id="btnSubmit" class="btn btn-primary">Subir y Analizar</button>
            <a href="{% url 'admin_dashboard' %}" class="btn btn-outline">Cancelar</a>
        </div>
    </form>

    <!-- Progress UI (Hidden by default) -->
    <div id="progressContainer" style="display: none; margin-top: 30px;">
        <h4 id="progressStatus">Iniciando...</h4>
        <div class="progress" style="height: 25px; background-color: #e9ecef; border-radius: 5px; overflow: hidden;">
            <div id="progressBar" class="progress-bar" role="progressbar"
                style="width: 0%; height: 100%; background-color: var(--color-primary); transition: width 0.5s;"></div>
        </div>
        <div class="text-center mt-2">
            <span id="progressText">0 / 0</span> filas procesadas
        </div>

        <!-- Result Log -->
        <div id="resultContainer"
            style="display: none; margin-top: 20px; padding: 15px; background: #fff; border: 1px solid #ddd; border-radius: 5px;">
            <h4 id="resultTitle">Resultado</h4>
            <p id="resultSummary"></p>
            <div id="errorZone" style="color: red;"></div>
            <a href="{% url 'admin_import_dashboard' %}" class="btn btn-primary mt-3">Volver al Dashboard</a>
        </div>
    </div>
</div>

<script>
    document.getElementById('importForm').addEventListener('submit', async function (e) {
        e.preventDefault();

        const form = e.target;
        const formData = new FormData(form);
        const btnSubmit = document.getElementById('btnSubmit');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const progressStatus = document.getElementById('progressStatus');
        const resultContainer = document.getElementById('resultContainer');

        // UI Update
        form.style.display = 'none';
        progressContainer.style.display = 'block';

        try {
            // 1. Start Import
            const response = await fetch(window.location.href, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });

            const data = await response.json();

            if (data.success) {
                const taskId = data.task_id;
                pollStatus(taskId);
            } else {
                alert('Error al iniciar: ' + data.error);
                form.style.display = 'block';
                progressContainer.style.display = 'none';
            }
        } catch (error) {
            console.error(error);
            alert('Error de conexión');
        }

        async function pollStatus(taskId) {
            const interval = setInterval(async () => {
                try {
                    const res = await fetch(`/admin-panel/importar/status/${taskId}/`);
                    const status = await res.json();

                    if (status.status === 'processing' || status.status === 'starting') {
                        // Update Bar
                        const total = status.total || 1;
                        const current = status.current || 0;
                        const percent = Math.round((current / total) * 100);

                        progressBar.style.width = percent + '%';
                        progressBar.innerText = percent + '%';
                        progressText.innerText = `${current} / ${total}`;
                        progressStatus.innerText = status.message;

                    } else if (status.status === 'completed') {
                        clearInterval(interval);
                        progressBar.style.width = '100%';
                        progressBar.innerText = '100%';
                        progressStatus.innerText = '¡Completado!';
                        progressBar.style.backgroundColor = '#28a745';

                        showResult(status.result);
                    } else if (status.status === 'failed') {
                        clearInterval(interval);
                        progressStatus.innerText = 'Falló';
                        progressBar.style.backgroundColor = '#dc3545';
                        alert('Error: ' + status.message);
                    }
                } catch (err) {
                    console.error(err);
                }
            }, 1000);
        }

        function showResult(result) {
            resultContainer.style.display = 'block';
            const created = result.created || 0;
            const updated = result.updated || 0;
            const errors = result.errors || 0;

            document.getElementById('resultSummary').innerHTML = `
            <strong>Creados:</strong> ${created} <br>
            <strong>Actualizados:</strong> ${updated} <br>
            <strong>Errores:</strong> ${errors}
        `;

            if (result.row_errors && result.row_errors.length > 0) {
                let errorHtml = '<h5>Detalle de Errores:</h5><ul>';
                result.row_errors.forEach(err => {
                    errorHtml += `<li>Fila ${err.row}: ${err.message}</li>`;
                });
                errorHtml += '</ul>';
                document.getElementById('errorZone').innerHTML = errorHtml;
            }
        }
    });
</script>
{% endblock %}