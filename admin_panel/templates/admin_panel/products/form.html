{% extends 'admin_panel/base.html' %}

{% block page_title %}{{ action }} Producto{% endblock %}

{% block content %}
<div class="admin-form-container">
    <h2>{{ action }} Producto</h2>

    <form method="post">
        {% csrf_token %}

        <div class="form-group">
            <label for="sku" class="form-label">SKU *</label>
            <input type="text" 
                   name="sku" 
                   id="sku" 
                   class="form-input" 
                   required 
                   value="{{ product.sku|default:'' }}" 
                   {% if not user.is_superuser %}disabled{% endif %}>
        </div>

        <div class="form-group">
            <label for="name" class="form-label">Nombre *</label>
            <input type="text" 
                   name="name" 
                   id="name" 
                   class="form-input" 
                   required 
                   value="{{ product.name|default:'' }}" 
                   {% if not user.is_superuser %}disabled{% endif %}>
        </div>

        <div class="form-group">
            <label for="supplier" class="form-label">Proveedor</label>
            <input type="text"
                   name="supplier"
                   id="supplier"
                   class="form-input"
                   list="supplierOptions"
                   value="{{ product.supplier|default:'' }}"
                   {% if not user.is_superuser %}disabled{% endif %}>
            <datalist id="supplierOptions">
                {% for supplier_name in supplier_suggestions %}
                <option value="{{ supplier_name }}"></option>
                {% endfor %}
            </datalist>
        </div>

        <div class="form-group">
            <label for="price" class="form-label">Precio *</label>
            <input type="number" 
                   step="0.01" 
                   name="price" 
                   id="price" 
                   class="form-input" 
                   required 
                   value="{{ product.price|default:'0' }}" 
                   {% if not user.is_superuser %}disabled{% endif %}>
        </div>

        <div class="form-group">
            <label for="stock" class="form-label">Stock</label>
            <input type="number" 
                   name="stock" 
                   id="stock" 
                   class="form-input" 
                   value="{{ product.stock|default:'0' }}" 
                   {% if not user.is_superuser %}disabled{% endif %}>
        </div>

        <div class="form-group">
            <label for="category" class="form-label">Categoria principal (atributos/filtros)</label>
            <select name="category"
                    id="category"
                    class="form-select"
                    onchange="loadCategoryAttributes(this.value); syncPrimaryWithChecks(this.value)"
                    {% if not user.is_superuser %}disabled{% endif %}>
                <option value="">Sin categoria principal</option>
                {% for cat in category_options %}
                <option value="{{ cat.id }}" {% if product.category_id == cat.id %}selected{% endif %}>
                    {{ cat.label }}
                </option>
                {% endfor %}
            </select>
            <small class="text-muted">Se usa para atributos dinamicos y compatibilidad.</small>
        </div>

        <div class="form-group">
            <label class="form-label">Categorias vinculadas (multi-categoria)</label>
            <input type="text" id="categorySearchInput" class="form-input" placeholder="Buscar categoria..." {% if not user.is_superuser %}disabled{% endif %}>
            <div class="category-check-grid" id="categoryCheckGrid">
                {% for cat in category_options %}
                <label class="category-check-item"
                       style="--depth: {{ cat.depth }};"
                       data-name="{{ cat.full_path|lower }} {{ cat.name|lower }}">
                    <input type="checkbox"
                           name="categories"
                           value="{{ cat.id }}"
                           class="category-check"
                           {% if cat.id in selected_category_ids %}checked{% endif %}
                           {% if not user.is_superuser %}disabled{% endif %}>
                    <span>
                        <strong>{{ cat.label }}</strong>
                        <small class="text-muted">{{ cat.full_path }}</small>
                    </span>
                </label>
                {% endfor %}
            </div>
            <small class="text-muted">Puedes vincular el producto a multiples categorias sin perder historial.</small>
        </div>

        <!-- Dynamic Attributes Container -->
        <div id="dynamic-attributes-container" class="form-group" style="display:none; border: 1px solid #eee; padding: 15px; border-radius: 5px; margin-top: 15px; background-color: #f9f9f9;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h4 style="margin: 0;">Atributos de Categoría</h4>
                <button type="button" 
                        id="btn-auto-detect" 
                        class="btn btn-sm btn-info" 
                        onclick="autoDetectAttributes()" 
                        {% if not user.is_superuser %}disabled style="display:none;"{% endif %}>
                    ✨ Auto-detectar desde Descripción
                </button>
            </div>
            <div id="attributes-fields">
                <!-- Fields will be injected here via JS -->
            </div>
            <!-- Hidden input to store JSON data -->
            <input type="hidden" name="attributes_json" id="attributes_json">
        </div>

        <div class="form-group">
            <label for="description" class="form-label">Descripción</label>
            <textarea name="description" 
                      id="description" 
                      class="form-textarea" 
                      {% if not user.is_superuser %}disabled{% endif %}>{{ product.description|default:'' }}</textarea>
        </div>

        {% if product %}
        <div class="form-group">
            <label class="form-label">
                <input type="checkbox" 
                       name="is_active" 
                       {% if product.is_active %}checked{% endif %} 
                       {% if not user.is_superuser %}disabled{% endif %}>
                Producto activo
            </label>
        </div>
        {% endif %}

        <div class="form-actions">
            {% if user.is_superuser %}
            <button type="submit" class="btn btn-primary">Guardar</button>
            {% else %}
            <button type="button" class="btn btn-primary" disabled title="Solo lectura">Solo Lectura</button>
            {% endif %}
            <a href="{% url 'admin_product_list' %}" class="btn btn-outline">Cancelar</a>
        </div>
    </form>
</div>

{{ product.attributes|json_script:"attributes-data" }}

<style>
    .category-check-grid {
        margin-top: 10px;
        max-height: 260px;
        overflow: auto;
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 8px;
        padding: 10px;
        display: grid;
        grid-template-columns: repeat(2, minmax(220px, 1fr));
        gap: 8px 14px;
    }
    .category-check-item {
        display: flex;
        align-items: center;
        gap: 8px;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 8px;
        padding: 8px 10px;
        padding-left: calc(10px + (var(--depth, 0) * 14px));
    }
    .category-check-item span {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }
    .category-check-item strong {
        font-size: 0.92rem;
        font-weight: 600;
    }
    @media (max-width: 900px) {
        .category-check-grid { grid-template-columns: 1fr; }
    }
</style>

<script>
    // Store current attributes if editing
    const currentAttributes = JSON.parse(document.getElementById('attributes-data').textContent || '{}');
    const isReadOnly = {% if user.is_superuser %}false{% else %}true{% endif %};

    document.addEventListener('DOMContentLoaded', function() {
        // Initial load
        loadCategoryAttributes();
        bindCategorySearch();

        // Intercept form submission to collect JSON
        const form = document.querySelector('form');
        form.addEventListener('submit', function(e) {
            try {
                collectAttributes();
            } catch (err) {
                e.preventDefault();
            }
        });
    });

    
    function bindCategorySearch() {
        const input = document.getElementById('categorySearchInput');
        const items = document.querySelectorAll('.category-check-item');
        if (!input) return;
        input.addEventListener('input', function() {
            const q = this.value.trim().toLowerCase();
            items.forEach(item => {
                const text = item.dataset.name || '';
                item.style.display = (!q || text.includes(q)) ? 'flex' : 'none';
            });
        });
    }

    function syncPrimaryWithChecks(primaryId) {
        if (!primaryId) return;
        const checkbox = document.querySelector(`.category-check[value="${primaryId}"]`);
        if (checkbox) checkbox.checked = true;
    }

    async function loadCategoryAttributes() {
        const categoryId = document.getElementById('category').value;
        const container = document.getElementById('dynamic-attributes-container');
        const fieldsContainer = document.getElementById('attributes-fields');

        if (!categoryId) {
            container.style.display = 'none';
            fieldsContainer.innerHTML = '';
            return;
        }

        try {
            const response = await fetch(`/admin-panel/api/category-attributes/${categoryId}/`);
            const data = await response.json();

            if (data.attributes && data.attributes.length > 0) {
                container.style.display = 'block';
                fieldsContainer.innerHTML = '';

                data.attributes.forEach(attr => {
                    const existingValue = currentAttributes[attr.slug] || '';
                    const requiredBadge = attr.required ? '<span style="color:#ff6b35;"> *obligatorio</span>' : '';
                    const recommendedBadge = (!attr.required && attr.is_recommended) ? '<span style=\"color:#20c997;\"> recomendado</span>' : '';
                    let fieldHtml = `<div class=\"form-group\" style=\"margin-bottom: 10px;\">
                        <label class=\"form-label\" style=\"font-size: 0.9em;\">${attr.name}${requiredBadge}${recommendedBadge}</label>`;

                    if (attr.type === 'select') {
                        const options = attr.options.split(',').map(o => o.trim());
                        fieldHtml += `<select name=\"attr_${attr.slug}\" class=\"form-select attr-field\" data-slug=\"${attr.slug}\" ${attr.required ? 'data-required=\"1\"' : ''} ${attr.is_recommended ? 'data-recommended=\"1\"' : ''} ${isReadOnly ? 'disabled' : ''}>
                            <option value="">- Seleccionar -</option>`;
                        options.forEach(opt => {
                            const selected = existingValue === opt ? 'selected' : '';
                            fieldHtml += `<option value="${opt}" ${selected}>${opt}</option>`;
                        });
                        fieldHtml += `</select>`;
                    } else {
                        fieldHtml += `<input type=\"text\" name=\"attr_${attr.slug}\" class=\"form-input attr-field\" 
                            data-slug=\"${attr.slug}\" ${attr.required ? 'data-required=\"1\"' : ''} ${attr.is_recommended ? 'data-recommended=\"1\"' : ''} value=\"${existingValue}\" ${isReadOnly ? 'disabled' : ''}>`;
                    }

                    if (attr.regex_pattern) {
                        fieldHtml += `<small class="text-muted" style="font-size: 0.8em; display: block; margin-top: 2px;">
                            Auto-extraíble via regex</small>`;
                    }

                    fieldHtml += `</div>`;
                    fieldsContainer.insertAdjacentHTML('beforeend', fieldHtml);
                });
            } else {
                container.style.display = 'none';
                fieldsContainer.innerHTML = '';
            }
        } catch (error) {
            console.error('Error loading attributes:', error);
        }
    }

    async function autoDetectAttributes() {
        const categoryId = document.getElementById('category').value;
        const description = document.getElementById('description').value;
        const btn = document.getElementById('btn-auto-detect');

        if (!categoryId || !description) {
            alert('Selecciona una categoría y escribe una descripción.');
            return;
        }

        btn.disabled = true;
        btn.innerHTML = 'Detectando...';

        try {
            // Need CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            const response = await fetch('/admin-panel/api/parse-description/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    category_id: categoryId,
                    description: description
                })
            });

            const data = await response.json();

            if (data.success && data.attributes) {
                let foundAny = false;
                Object.entries(data.attributes).forEach(([slug, value]) => {
                    const field = document.querySelector(`.attr-field[data-slug="${slug}"]`);
                    if (field) {
                        field.value = value;
                        // Use a distinct color to show it was auto-detected
                        field.style.borderColor = '#2ecc71';
                        foundAny = true;
                    }
                });

                if (foundAny) {
                    // alert('Atributos detectados y completados.');
                } else {
                    alert('No se encontraron coincidencias con los patrones definidos.');
                }
            } else {
                alert('Error: ' + (data.error || 'Desconocido'));
            }
        } catch (error) {
            console.error('Error parsing description:', error);
            alert('Error al conectar con el servidor.');
        } finally {
            btn.disabled = false;
            btn.innerHTML = '✨ Auto-detectar desde Descripción';
        }
    }

    function collectAttributes() {
        const fields = document.querySelectorAll('.attr-field');
        const attributes = {};
        const missingRequired = [];
        const missingRecommended = [];

        fields.forEach(field => {
            if (field.value) {
                attributes[field.dataset.slug] = field.value;
            } else {
                if (field.dataset.required === '1') {
                    missingRequired.push(field.dataset.slug);
                } else if (field.dataset.recommended === '1') {
                    missingRecommended.push(field.dataset.slug);
                }
            }
        });

        if (missingRequired.length > 0) {
            alert(`Faltan atributos obligatorios: ${missingRequired.join(', ')}`);
            throw new Error('Atributos obligatorios incompletos');
        }
        if (missingRecommended.length > 0) {
            console.warn('Atributos recomendados faltantes:', missingRecommended.join(', '));
        }

        document.getElementById('attributes_json').value = JSON.stringify(attributes);
    }
</script>
{% endblock %}
