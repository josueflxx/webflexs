{% extends 'admin_panel/base.html' %}

{% block page_title %}Cotizador{% endblock %}

{% block content %}
<div class="admin-table-container">
    <div class="admin-toolbar">
        <div>
            <h2 style="margin:0;">Mini Cotizador de Abrazaderas</h2>
            <p class="text-muted" style="margin:6px 0 0;">
                Calcula costo base y listas de venta en base a dolar, acero y datos tecnicos.
            </p>
        </div>
    </div>

    <div class="clamp-quoter-layout">
        <section class="clamp-quoter-card clamp-quoter-card-form">
            <div class="clamp-form-title">Datos de Cotizacion</div>

            <div class="clamp-rows">
                <div class="clamp-row">
                    <label class="clamp-row-label" for="dollar_rate">Dolar:</label>
                    <div class="clamp-row-control">
                        <label class="clamp-radio-inline">
                            <input type="radio" name="dollar_mode" id="dollar_mode_manual" value="manual"
                                {% if form_values.dollar_mode != 'auto' %}checked{% endif %}>
                            Manual
                        </label>
                        <label class="clamp-radio-inline">
                            <input type="radio" name="dollar_mode" id="dollar_mode_auto" value="auto"
                                {% if form_values.dollar_mode == 'auto' %}checked{% endif %}>
                            Auto (API)
                        </label>
                        <input id="dollar_rate" type="number" step="0.01" min="0" class="form-input"
                            value="{{ form_values.dollar_rate }}" placeholder="Valor Dolar">
                    </div>
                </div>

                <div class="clamp-row">
                    <label class="clamp-row-label" for="steel_price_usd">Precio Acero (USD):</label>
                    <div class="clamp-row-control">
                        <input id="steel_price_usd" type="number" step="0.0001" min="0" class="form-input"
                            value="{{ form_values.steel_price_usd }}">
                    </div>
                </div>

                <div class="clamp-row">
                    <label class="clamp-row-label" for="supplier_discount_pct">Desc. Proveedor (%):</label>
                    <div class="clamp-row-control">
                        <input id="supplier_discount_pct" type="number" step="0.01" min="0" class="form-input"
                            value="{{ form_values.supplier_discount_pct }}">
                    </div>
                </div>

                <div class="clamp-row">
                    <label class="clamp-row-label" for="general_increase_pct">Aumento Gral. (%):</label>
                    <div class="clamp-row-control">
                        <input id="general_increase_pct" type="number" step="0.01" min="0" class="form-input"
                            value="{{ form_values.general_increase_pct }}">
                    </div>
                </div>

                <div class="clamp-row">
                    <label class="clamp-row-label" for="clamp_type">Tipo Abrazadera:</label>
                    <div class="clamp-row-control clamp-controls-inline">
                        <label class="clamp-radio-inline">
                            <input type="radio" name="clamp_type_radio" value="trefilada"
                                {% if form_values.clamp_type == 'trefilada' %}checked{% endif %}>
                            Trefilada
                        </label>
                        <label class="clamp-radio-inline">
                            <input type="radio" name="clamp_type_radio" value="laminada"
                                {% if form_values.clamp_type == 'laminada' %}checked{% endif %}>
                            Laminada
                        </label>
                        <label class="clamp-checkbox-inline clamp-zinc-inline">
                            <input id="is_zincated" type="checkbox" {% if form_values.is_zincated %}checked{% endif %}>
                            Zincado (+20%)
                        </label>
                        <select id="clamp_type" class="form-select clamp-hidden-select" aria-hidden="true" tabindex="-1">
                            <option value="trefilada" {% if form_values.clamp_type == 'trefilada' %}selected{% endif %}>Trefilada</option>
                            <option value="laminada" {% if form_values.clamp_type == 'laminada' %}selected{% endif %}>Laminada</option>
                        </select>
                    </div>
                </div>

                <div class="clamp-row">
                    <label class="clamp-row-label" for="diameter">Diametro:</label>
                    <div class="clamp-row-control">
                        <select id="diameter" class="form-select clamp-select-highlight">
                            {% for diameter in diameter_options %}
                            <option value="{{ diameter }}" {% if form_values.diameter == diameter %}selected{% endif %}>
                                {{ diameter }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="clamp-row">
                    <label class="clamp-row-label" for="width_mm">Ancho (mm):</label>
                    <div class="clamp-row-control">
                        <input id="width_mm" type="number" step="1" min="1" class="form-input" value="{{ form_values.width_mm }}">
                    </div>
                </div>

                <div class="clamp-row">
                    <label class="clamp-row-label" for="length_mm">Largo (mm):</label>
                    <div class="clamp-row-control">
                        <input id="length_mm" type="number" step="1" min="1" class="form-input" value="{{ form_values.length_mm }}">
                    </div>
                </div>

                <div class="clamp-row">
                    <label class="clamp-row-label" for="profile_type">Tipo:</label>
                    <div class="clamp-row-control">
                        <select id="profile_type" class="form-select clamp-select-highlight">
                            {% for profile in profile_options %}
                            <option value="{{ profile }}" {% if form_values.profile_type == profile %}selected{% endif %}>
                                {{ profile }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="clamp-row">
                    <label class="clamp-row-label" for="client_name">Cliente:</label>
                    <div class="clamp-row-control">
                        <input id="client_name" type="text" class="form-input" value="{{ form_values.client_name }}">
                    </div>
                </div>

                <div class="clamp-row">
                    <label class="clamp-row-label" for="product_stock">Stock inicial:</label>
                    <div class="clamp-row-control">
                        <input id="product_stock" type="number" step="1" min="1" class="form-input" value="{{ form_values.product_stock|default:'1' }}">
                    </div>
                </div>
            </div>

            <div class="clamp-code-logic-card">
                <h4>Logica del Codigo</h4>
                <p class="text-muted" style="margin:0 0 8px;">
                    Estructura: <code>PREFIJO + MEDIDA_COMPACTADA + ANCHO + LARGO + FORMA</code>
                </p>
                <div class="clamp-code-parts">
                    <span class="clamp-code-pill"><small>Prefijo</small><strong id="codePartPrefix">ABT</strong></span>
                    <span class="clamp-code-pill"><small>Medida</small><strong id="codePartDiameter">716</strong></span>
                    <span class="clamp-code-pill"><small>Ancho</small><strong id="codePartWidth">...</strong></span>
                    <span class="clamp-code-pill"><small>Largo</small><strong id="codePartLength">...</strong></span>
                    <span class="clamp-code-pill"><small>Forma</small><strong id="codePartShape">P</strong></span>
                </div>
                <div class="clamp-code-final-line">
                    <span>Codigo resultante:</span>
                    <code id="codePartFinal">ABT716... ...P</code>
                    <span id="codePartWarn" class="badge badge-warning" style="display:none;">Diametro requiere mapeo</span>
                </div>
            </div>

            <div class="form-actions clamp-actions">
                <button type="button" class="btn clamp-btn-calc" onclick="runClampCalculation()">CALCULAR</button>
                <small id="calcError" class="text-muted clamp-error"></small>
            </div>
        </section>
    </div>

    <section class="clamp-results-card" id="clampResultsCard" style="display:none;">
        <div class="clamp-results-header">
            <h3 style="margin:0;">Resultado</h3>
            <span class="badge badge-info" id="resultWeight">Peso: -</span>
        </div>
        <p id="resultDescription" class="clamp-result-description">-</p>
        <p class="clamp-result-code-line">
            Codigo sugerido:
            <code id="resultCode">-</code>
            <span id="resultCodeWarn" class="badge badge-warning" style="display:none;">Requiere mapeo de diametro</span>
        </p>
        <div class="clamp-result-metrics">
            <div class="metric">
                <span>Costo base</span>
                <strong id="resultBaseCost">$0,00</strong>
            </div>
            <div class="metric">
                <span>Desarrollo</span>
                <strong id="resultDevelopment">0.0000 m</strong>
            </div>
        </div>
        <div id="priceCards" class="clamp-price-grid"></div>
    </section>

    <section class="clamp-results-card">
        <div class="clamp-results-header">
            <h3 style="margin:0;">Ultimas cotizaciones guardadas</h3>
            <span class="badge badge-secondary">{{ saved_quotes|length }} registros</span>
        </div>
        <div class="products-table-wrapper">
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Cliente</th>
                        <th>Descripcion</th>
                        <th>Lista</th>
                        <th>Costo base</th>
                        <th>Peso (kg)</th>
                        <th>Precio final</th>
                        <th>Usuario</th>
                    </tr>
                </thead>
                <tbody>
                    {% for quote in saved_quotes %}
                    <tr>
                        <td>{{ quote.created_at|date:"d/m/Y H:i" }}</td>
                        <td>{{ quote.client_name|default:"-" }}</td>
                        <td>{{ quote.description }}</td>
                        <td>{{ quote.get_price_list_display }}</td>
                        <td>${{ quote.base_cost|floatformat:2 }}</td>
                        <td>
                            {% if quote.calculated_weight_kg %}
                            {{ quote.calculated_weight_kg|floatformat:4 }}
                            {% else %}
                            -
                            {% endif %}
                        </td>
                        <td><strong>${{ quote.final_price|floatformat:2 }}</strong></td>
                        <td>{{ quote.created_by.username|default:"sistema" }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="text-center text-muted">Todavia no hay cotizaciones guardadas.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </section>
</div>

<form id="saveQuoteForm" method="post" style="display:none;">
    {% csrf_token %}
    <input type="hidden" name="action" id="form_action" value="save_quote">
    <input type="hidden" name="price_list_key" id="save_price_list_key">
    <input type="hidden" name="client_name" id="save_client_name">
    <input type="hidden" name="dollar_mode" id="save_dollar_mode">
    <input type="hidden" name="dollar_rate" id="save_dollar_rate">
    <input type="hidden" name="steel_price_usd" id="save_steel_price_usd">
    <input type="hidden" name="supplier_discount_pct" id="save_supplier_discount_pct">
    <input type="hidden" name="general_increase_pct" id="save_general_increase_pct">
    <input type="hidden" name="clamp_type" id="save_clamp_type">
    <input type="hidden" name="is_zincated" id="save_is_zincated">
    <input type="hidden" name="diameter" id="save_diameter">
    <input type="hidden" name="width_mm" id="save_width_mm">
    <input type="hidden" name="length_mm" id="save_length_mm">
    <input type="hidden" name="profile_type" id="save_profile_type">
    <input type="hidden" name="product_stock" id="save_product_stock">
</form>

<script>
    const CLAMP_WEIGHT_MAP = {{ weight_map_json|safe }};
    const DIAMETER_CODE_MAP = {{ diameter_code_map_json|safe }};
    const ALL_DIAMETER_OPTIONS = {{ all_diameter_options_json|safe }};
    const LAMINATED_DIAMETER_OPTIONS = {{ laminated_diameter_options_json|safe }};
    const CLAMP_PRICE_LISTS = {{ price_lists_json|safe }};
    const CLAMP_ADJUSTMENTS = {
        PLANA: 20,
        SEMICURVA: 10,
        CURVA: 0,
    };

    function parseNumericInput(inputId, label, allowZero = false) {
        const raw = (document.getElementById(inputId)?.value || '').trim().replace(',', '.');
        const parsed = Number(raw);
        if (!Number.isFinite(parsed) || (!allowZero && parsed <= 0) || (allowZero && parsed < 0)) {
            throw new Error(`${label} invalido.`);
        }
        return parsed;
    }

    function parseIntegerInput(inputId, label) {
        const raw = (document.getElementById(inputId)?.value || '').trim();
        const parsed = Number(raw);
        if (!Number.isInteger(parsed) || parsed <= 0) {
            throw new Error(`${label} debe ser un entero mayor a 0.`);
        }
        return parsed;
    }

    function formatMoney(value) {
        return new Intl.NumberFormat('es-AR', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
        }).format(value);
    }

    function normalizeKey(value) {
        return String(value || '').trim().replace(/\s+/g, ' ').toUpperCase();
    }

    function getAllowedDiameters(clampType) {
        return clampType === 'laminada'
            ? LAMINATED_DIAMETER_OPTIONS.slice()
            : ALL_DIAMETER_OPTIONS.slice();
    }

    function syncDiameterOptions(clampTypeOverride = null) {
        const clampType = (clampTypeOverride || getCurrentClampType()).toLowerCase();
        const select = document.getElementById('diameter');
        if (!select) return;

        const allowed = getAllowedDiameters(clampType);
        const previousValue = select.value;

        select.innerHTML = allowed
            .map((diameter) => `<option value="${diameter}">${diameter}</option>`)
            .join('');

        if (allowed.includes(previousValue)) {
            select.value = previousValue;
        } else if (allowed.length > 0) {
            select.value = allowed[0];
        }
    }

    function compactDiameterForCode(diameterValue) {
        const normalized = normalizeKey(diameterValue);
        if (Object.prototype.hasOwnProperty.call(DIAMETER_CODE_MAP, normalized)) {
            return {
                compact: DIAMETER_CODE_MAP[normalized],
                requiresMapping: false,
            };
        }
        const compact = normalized.replace(/[^0-9]/g, '');
        return {
            compact,
            requiresMapping: /[\/\s]/.test(normalized),
        };
    }

    function generateCodeSuggestion(state) {
        const prefix = state.clampType === 'laminada' ? 'ABL' : 'ABT';
        const shapeCodeMap = {
            PLANA: 'P',
            SEMICURVA: 'S',
            CURVA: 'C',
        };
        const compactInfo = compactDiameterForCode(state.diameter);
        const shapeCode = shapeCodeMap[state.profileType] || 'P';
        const code = `${prefix}${compactInfo.compact}${state.widthMm}${state.lengthMm}${shapeCode}`;
        return {
            code,
            prefix,
            shapeCode,
            compactMeasure: compactInfo.compact,
            requiresMapping: compactInfo.requiresMapping,
        };
    }

    function getCurrentClampType() {
        return (
            document.querySelector('input[name="clamp_type_radio"]:checked')?.value
            || document.getElementById('clamp_type')?.value
            || 'trefilada'
        ).toLowerCase();
    }

    function getCurrentShapeCode() {
        const profileType = (document.getElementById('profile_type')?.value || 'PLANA').toUpperCase();
        const shapeCodeMap = {
            PLANA: 'P',
            SEMICURVA: 'S',
            CURVA: 'C',
        };
        return shapeCodeMap[profileType] || 'P';
    }

    function renderCodeLogicPreview() {
        const clampType = getCurrentClampType();
        const prefix = clampType === 'laminada' ? 'ABL' : 'ABT';
        const diameterValue = document.getElementById('diameter')?.value || '';
        const compactInfo = compactDiameterForCode(diameterValue);
        const widthRaw = (document.getElementById('width_mm')?.value || '').trim().replace(/\D/g, '');
        const lengthRaw = (document.getElementById('length_mm')?.value || '').trim().replace(/\D/g, '');
        const shapeCode = getCurrentShapeCode();
        const widthPart = widthRaw || '...';
        const lengthPart = lengthRaw || '...';
        const codeValue = `${prefix}${compactInfo.compact}${widthPart}${lengthPart}${shapeCode}`;

        const prefixNode = document.getElementById('codePartPrefix');
        const diameterNode = document.getElementById('codePartDiameter');
        const widthNode = document.getElementById('codePartWidth');
        const lengthNode = document.getElementById('codePartLength');
        const shapeNode = document.getElementById('codePartShape');
        const finalNode = document.getElementById('codePartFinal');
        const warnNode = document.getElementById('codePartWarn');

        if (prefixNode) prefixNode.textContent = prefix;
        if (diameterNode) diameterNode.textContent = compactInfo.compact || '...';
        if (widthNode) widthNode.textContent = widthPart;
        if (lengthNode) lengthNode.textContent = lengthPart;
        if (shapeNode) shapeNode.textContent = shapeCode;
        if (finalNode) finalNode.textContent = codeValue;
        if (warnNode) {
            warnNode.style.display = compactInfo.requiresMapping ? 'inline-flex' : 'none';
        }
    }

    function normalizeClampInputState() {
        const clampType = (
            document.querySelector('input[name="clamp_type_radio"]:checked')?.value
            || document.getElementById('clamp_type')?.value
            || 'trefilada'
        ).toLowerCase();
        const diameter = document.getElementById('diameter')?.value || '';
        const profileType = (document.getElementById('profile_type')?.value || 'PLANA').toUpperCase();
        const dollarMode = document.getElementById('dollar_mode_auto')?.checked ? 'auto' : 'manual';
        const hiddenClampTypeSelect = document.getElementById('clamp_type');
        if (hiddenClampTypeSelect) {
            hiddenClampTypeSelect.value = clampType;
        }

        if (!Object.prototype.hasOwnProperty.call(CLAMP_WEIGHT_MAP, diameter)) {
            throw new Error('Diametro invalido.');
        }
        if (clampType === 'laminada' && !LAMINATED_DIAMETER_OPTIONS.includes(diameter)) {
            throw new Error('Para laminada solo se permiten 3/4, 1 y 7/8.');
        }
        if (!Object.prototype.hasOwnProperty.call(CLAMP_ADJUSTMENTS, profileType)) {
            throw new Error('Tipo invalido.');
        }

        return {
            clientName: (document.getElementById('client_name')?.value || '').trim(),
            clampType,
            diameter,
            profileType,
            isZincated: !!document.getElementById('is_zincated')?.checked,
            dollarMode,
            dollarRate: parseNumericInput('dollar_rate', 'Dolar'),
            steelPriceUsd: parseNumericInput('steel_price_usd', 'Precio Acero (USD)'),
            supplierDiscountPct: parseNumericInput('supplier_discount_pct', 'Desc. Proveedor (%)', true),
            generalIncreasePct: parseNumericInput('general_increase_pct', 'Aumento Gral. (%)', true),
            widthMm: parseIntegerInput('width_mm', 'Ancho (mm)'),
            lengthMm: parseIntegerInput('length_mm', 'Largo (mm)'),
        };
    }

    function calculateClampQuote() {
        const state = normalizeClampInputState();

        // Paso A
        const adjustment = CLAMP_ADJUSTMENTS[state.profileType];

        // Paso B
        const developmentMeters = ((state.lengthMm * 2) + state.widthMm + adjustment) / 1000;
        const weightPerMeter = CLAMP_WEIGHT_MAP[state.diameter];
        const totalWeightKg = developmentMeters * weightPerMeter;

        // Paso C
        const discountFactor = 1 - (state.supplierDiscountPct / 100);
        const increaseFactor = 1 + (state.generalIncreasePct / 100);

        // Paso D
        let baseCost = totalWeightKg * state.steelPriceUsd * discountFactor * state.dollarRate * increaseFactor;

        // Paso E
        if (state.isZincated) {
            baseCost = baseCost * 1.20;
        }
        if (state.clampType === 'laminada') {
            baseCost = baseCost / 2.0;
        }

        const clampTypeLabel = state.clampType === 'laminada' ? 'LAMINADA' : 'TREFILADA';
        const zincLabel = state.isZincated ? ' ZINCADA' : '';
        const description = `ABRAZADERA ${clampTypeLabel}${zincLabel} DE ${state.diameter} X ${state.widthMm} X ${state.lengthMm} ${state.profileType}`;

        const lists = CLAMP_PRICE_LISTS.map((row) => ({
            key: row.key,
            label: row.label,
            multiplier: row.multiplier,
            finalPrice: baseCost * row.multiplier,
        }));
        const codeSuggestion = generateCodeSuggestion(state);

        return {
            state,
            description,
            baseCost,
            developmentMeters,
            totalWeightKg,
            lists,
            codeSuggestion,
        };
    }

    function renderClampResults(result) {
        const resultCard = document.getElementById('clampResultsCard');
        const cardsContainer = document.getElementById('priceCards');
        if (!resultCard || !cardsContainer) return;

        resultCard.style.display = 'block';
        document.getElementById('resultDescription').textContent = result.description;
        document.getElementById('resultCode').textContent = result.codeSuggestion.code || '-';
        const codeWarn = document.getElementById('resultCodeWarn');
        if (codeWarn) {
            codeWarn.style.display = result.codeSuggestion.requiresMapping ? 'inline-flex' : 'none';
        }
        document.getElementById('resultBaseCost').textContent = `$${formatMoney(result.baseCost)}`;
        document.getElementById('resultDevelopment').textContent = `${result.developmentMeters.toFixed(4)} m`;
        document.getElementById('resultWeight').textContent = `Peso: ${result.totalWeightKg.toFixed(4)} kg`;

        cardsContainer.innerHTML = result.lists.map((item) => `
            <article class="clamp-price-card">
                <h4>${item.label}</h4>
                <small>x${item.multiplier.toFixed(1)}</small>
                <strong>$${formatMoney(item.finalPrice)}</strong>
                <small>Peso: ${result.totalWeightKg.toFixed(4)} kg</small>
                <small>Costo base: $${formatMoney(result.baseCost)}</small>
                <button type="button" class="btn btn-primary btn-sm" onclick="submitClampAction('${item.key}', 'save_quote')">
                    Guardar cotizacion
                </button>
                <button type="button" class="btn btn-outline btn-sm" onclick="submitClampAction('${item.key}', 'create_product')">
                    Agregar a productos
                </button>
            </article>
        `).join('');
    }

    function showCalcError(message) {
        const errorNode = document.getElementById('calcError');
        if (!errorNode) return;
        errorNode.textContent = message || '';
    }

    function runClampCalculation() {
        try {
            const result = calculateClampQuote();
            showCalcError('');
            renderClampResults(result);
        } catch (error) {
            showCalcError(error.message || 'No se pudo calcular.');
        }
    }

    function copyInputToHidden(sourceId, targetId, transform = null) {
        const source = document.getElementById(sourceId);
        const target = document.getElementById(targetId);
        if (!source || !target) return;
        const value = transform ? transform(source) : source.value;
        target.value = value;
    }

    function submitClampAction(priceListKey, actionName) {
        try {
            // Validate state before submit.
            calculateClampQuote();
            showCalcError('');
        } catch (error) {
            showCalcError(error.message || 'No se pudo guardar la cotizacion.');
            return;
        }

        copyInputToHidden('client_name', 'save_client_name');
        const dollarModeTarget = document.getElementById('save_dollar_mode');
        if (dollarModeTarget) {
            dollarModeTarget.value = document.getElementById('dollar_mode_auto')?.checked ? 'auto' : 'manual';
        }
        copyInputToHidden('dollar_rate', 'save_dollar_rate');
        copyInputToHidden('steel_price_usd', 'save_steel_price_usd');
        copyInputToHidden('supplier_discount_pct', 'save_supplier_discount_pct');
        copyInputToHidden('general_increase_pct', 'save_general_increase_pct');
        const selectedClampType = document.querySelector('input[name="clamp_type_radio"]:checked')?.value || 'trefilada';
        const saveClampType = document.getElementById('save_clamp_type');
        if (saveClampType) {
            saveClampType.value = selectedClampType;
        }
        copyInputToHidden('diameter', 'save_diameter');
        copyInputToHidden('width_mm', 'save_width_mm');
        copyInputToHidden('length_mm', 'save_length_mm');
        copyInputToHidden('profile_type', 'save_profile_type');
        copyInputToHidden('product_stock', 'save_product_stock');

        const zincSource = document.getElementById('is_zincated');
        const zincTarget = document.getElementById('save_is_zincated');
        if (zincSource && zincTarget) {
            zincTarget.value = zincSource.checked ? '1' : '0';
        }

        const priceListInput = document.getElementById('save_price_list_key');
        if (priceListInput) {
            priceListInput.value = priceListKey;
        }

        const actionInput = document.getElementById('form_action');
        if (actionInput) {
            actionInput.value = actionName || 'save_quote';
        }

        document.getElementById('saveQuoteForm')?.submit();
    }

    async function fetchDollarRate() {
        const input = document.getElementById('dollar_rate');
        if (!input) return;
        try {
            showCalcError('');
            const response = await fetch('https://dolarapi.com/v1/dolares/mayorista');
            if (!response.ok) {
                throw new Error('No se pudo consultar dolarapi.');
            }
            const payload = await response.json();
            if (!payload || typeof payload.venta === 'undefined') {
                throw new Error('Respuesta invalida de dolarapi.');
            }
            input.value = Number(payload.venta).toFixed(2);
        } catch (error) {
            showCalcError(error.message || 'No se pudo actualizar el dolar en automatico.');
        }
    }

    function setDollarMode(mode, shouldFetch) {
        const input = document.getElementById('dollar_rate');
        if (!input) return;
        const isAuto = mode === 'auto';
        input.disabled = isAuto;
        if (isAuto && shouldFetch) {
            fetchDollarRate();
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        const manualRadio = document.getElementById('dollar_mode_manual');
        const autoRadio = document.getElementById('dollar_mode_auto');
        const initialAuto = !!autoRadio?.checked;
        setDollarMode(initialAuto ? 'auto' : 'manual', initialAuto && !(document.getElementById('dollar_rate')?.value || '').trim());
        manualRadio?.addEventListener('change', () => {
            if (manualRadio.checked) {
                setDollarMode('manual', false);
            }
        });
        autoRadio?.addEventListener('change', () => {
            if (autoRadio.checked) {
                setDollarMode('auto', true);
            }
        });
        document.querySelectorAll('input[name="clamp_type_radio"]').forEach((radio) => {
            radio.addEventListener('change', () => {
                const clampTypeSelect = document.getElementById('clamp_type');
                if (clampTypeSelect) {
                    clampTypeSelect.value = radio.value;
                }
                syncDiameterOptions(radio.value);
                renderCodeLogicPreview();
            });
        });
        ['diameter', 'width_mm', 'length_mm', 'profile_type'].forEach((id) => {
            const node = document.getElementById(id);
            node?.addEventListener('input', renderCodeLogicPreview);
            node?.addEventListener('change', renderCodeLogicPreview);
        });
        syncDiameterOptions();
        renderCodeLogicPreview();

        // Pre-calculate only when required values are present.
        const width = (document.getElementById('width_mm')?.value || '').trim();
        const length = (document.getElementById('length_mm')?.value || '').trim();
        if (width && length) {
            runClampCalculation();
        }
    });
</script>
{% endblock %}
